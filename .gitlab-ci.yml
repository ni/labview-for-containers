# GitLab CI/CD Pipeline — Run LabVIEWCLI on LabVIEW Containers
#
# This pipeline mirrors the GitHub Actions workflows at
# .github/workflows/labview-container-check.yml and
# .github/workflows/labview-container-check-windows.yml
#
# It runs on merge request events and executes LabVIEWCLI operations
# inside LabVIEW container images from Docker Hub.

stages:
  - validation

# ──────────────────────────────────────────────
#  Linux Job
# ──────────────────────────────────────────────
run-labview-cli-linux:
  stage: validation
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
    LABVIEW_IMAGE: "nationalinstruments/labview:latest-linux"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
  before_script:
    - docker pull "$LABVIEW_IMAGE"
  script:
    # 1. Run LabVIEWCLI MassCompile on Arrays examples
    - >
      docker run --rm
      "$LABVIEW_IMAGE"
      bash -c "LabVIEWCLI
      -OperationName MassCompile
      -DirectoryToCompile /usr/local/natinst/LabVIEW-2026-64/examples/Arrays
      -LabVIEWPath /usr/local/natinst/LabVIEW-2026-64/labview
      -Headless"

    # 2. Run CI integration script in container (mount repo into /workspace)
    - >
      docker run --rm
      -v "$CI_PROJECT_DIR:/workspace"
      "$LABVIEW_IMAGE"
      bash -c "cd /workspace/examples/integration-into-cicd && chmod +x runlabview.sh && ./runlabview.sh"

# ──────────────────────────────────────────────
#  Windows Job (requires a self-hosted Windows runner — see docs/gitlab-cicd.md)
# ──────────────────────────────────────────────
run-labview-cli-windows:
  stage: validation
  tags:
    - windows
    - docker
  variables:
    LABVIEW_IMAGE: "nationalinstruments/labview:latest-windows"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true
  before_script:
    - docker pull "$LABVIEW_IMAGE"
  script:
    # 1. Run LabVIEWCLI MassCompile on Arrays examples
    - >
      docker run --rm
      "$LABVIEW_IMAGE"
      LabVIEWCLI -OperationName MassCompile
      -DirectoryToCompile "C:\Program Files\National Instruments\LabVIEW 2026\examples\Arrays"
      -Headless

    # 2. Run CI integration script in container (mount repo into C:\workspace)
    - >
      docker run --rm
      -v "${CI_PROJECT_DIR}:C:\workspace"
      "$LABVIEW_IMAGE"
      powershell -File "C:\workspace\examples\integration-into-cicd\runlabview.ps1"
      -WorkspaceRoot "C:\workspace"
